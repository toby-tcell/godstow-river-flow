<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godstow River Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #1a1a2e;
            margin-bottom: 50px;
            padding-top: 20px;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1.3em;
            color: #4a4a5e;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .header-updated {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 15px;
            font-weight: 500;
        }

        .flag-display {
            font-size: 6em;
            margin: 20px 0;
            line-height: 1;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        .flag-text {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }

        .flag-description {
            font-size: 1.4em;
            color: #6b7280;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .flow-trend {
            font-size: 1.3em;
            margin-top: 15px;
            font-weight: 600;
        }

        .trend-icon {
            font-size: 1.4em;
            margin-right: 8px;
        }

        .loading {
            text-align: center;
            padding: 80px;
            color: #1a1a2e;
            font-size: 1.5em;
            font-weight: 500;
        }

        .spinner {
            border: 5px solid #e0e0e0;
            border-top: 5px solid #1a1a2e;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s ease-in-out infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fff5f5;
            color: #c53030;
            padding: 30px;
            border-radius: 16px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #fc8181;
            font-weight: 500;
        }

        .last-updated {
            text-align: center;
            color: #6b7280;
            margin-top: 40px;
            font-size: 1em;
            font-weight: 500;
        }

        .stale-warning {
            background: #fffbeb;
            color: #92400e;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1em;
            text-align: center;
            margin-bottom: 25px;
            border: 2px solid #fbbf24;
            font-weight: 600;
        }

        .flag-item-status {
            font-size: 3.5em;
            margin: 15px 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .flag-item-text {
            font-size: 1.5em;
            font-weight: 700;
            color: #1f2937;
            letter-spacing: -0.3px;
        }

        .flag-item-meta {
            font-size: 0.9em;
            color: #9ca3af;
            margin-top: 12px;
            font-weight: 500;
        }

        .flag-notice {
            font-size: 0.95em;
            color: #92400e;
            background: #fffbeb;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 500;
            border: 1px solid #fbbf24;
        }

        .highlight {
            background: #f8f9fa;
            border-left: 5px solid #1a1a2e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        /* ========================================
           STANDARDISED CARD SYSTEM
           ======================================== */

        /* Primary card - main content boxes with shadow */
        .card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #1f2937;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-align: center;
        }

        .card p {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 1.05em;
        }

        /* Secondary card - nested boxes with border (no shadow) */
        .card-secondary {
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e0e0e0;
        }

        /* Compact secondary card for smaller nested items */
        .card-secondary--compact {
            padding: 20px;
        }

        /* Card label - uppercase label text */
        .card-label {
            font-size: 1em;
            color: #6b7280;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* Card value - large numeric display */
        .card-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #1f2937;
        }

        .card-value--large {
            font-size: 3.5em;
            font-weight: 800;
            color: #1a1a2e;
        }

        .card-value--accent {
            color: #3b82f6;
        }

        /* Grid layouts for cards */
        .card-grid {
            display: grid;
            gap: 20px;
        }

        .card-grid--2col {
            grid-template-columns: 1fr 1fr;
        }

        /* Event card - dark themed for countdowns */
        .card-event {
            text-align: center;
            padding: 30px 20px;
            border-radius: 16px;
            border: 2px solid transparent;
        }

        .card-event--dark {
            background: #1a1a2e;
            border-color: #1a1a2e;
        }

        .card-event--red {
            background: #dc2626;
            border-color: #dc2626;
        }

        .card-event__value {
            font-size: 3em;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
        }

        .card-event__label {
            color: rgba(255,255,255,0.9);
            margin-top: 8px;
            font-weight: 500;
            font-size: 1.05em;
        }

        /* Weather forecast card */
        .card-weather {
            text-align: center;
            padding: 15px 10px;
            background: #ffffff;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .card-weather__time {
            font-size: 0.95em;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-weather__icon {
            font-size: 2.2em;
            margin: 8px 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .card-weather__temp {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.1em;
        }

        .card-weather__chance {
            font-size: 0.9em;
            color: #3b82f6;
            font-weight: 600;
            margin-top: 4px;
        }

        .card-weather__precip {
            font-size: 0.85em;
            color: #10b981;
            font-weight: 700;
            margin-top: 4px;
        }

        /* Weather forecast grid */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .nav-link {
            color: #1a1a2e;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: inline-block;
            transition: background 0.2s;
        }

        .nav-link:hover {
            background: #e9ecef;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .current-flow-value {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .current-flow-value .label {
            font-size: 1em;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .current-flow-value .value {
            font-size: 3em;
            font-weight: 800;
            color: #1a1a2e;
        }

        .current-flow-value .unit {
            font-size: 1.2em;
            color: #6b7280;
            font-weight: 500;
        }

        .current-flow-value .timestamp {
            font-size: 0.9em;
            color: #9ca3af;
            margin-top: 10px;
        }

        .flag-thresholds {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .threshold-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #6b7280;
        }

        .threshold-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            h1 {
                font-size: 2em;
            }

            .subtitle {
                font-size: 1.1em;
            }

            .header-updated {
                font-size: 0.8em;
            }

            .flag-display {
                font-size: 4.5em !important;
                margin: 15px 0 !important;
            }

            .flag-text {
                font-size: 2.2em !important;
                margin-bottom: 15px !important;
            }

            .flag-description {
                font-size: 1.2em !important;
                margin-bottom: 20px !important;
            }

            .highlight {
                font-size: 0.95em;
                padding: 15px;
            }

            .chart-container {
                height: 300px;
            }

            .current-flow-value .value {
                font-size: 2.5em;
            }

            /* Card system mobile overrides */
            .card {
                padding: 25px 20px;
                border-radius: 16px;
            }

            .card h3 {
                font-size: 1.5em;
            }

            .card p {
                font-size: 1em;
            }

            .card-secondary {
                padding: 20px;
                border-radius: 12px;
            }

            .card-secondary--compact {
                padding: 15px;
            }

            .card-grid--2col {
                grid-template-columns: 1fr;
            }

            .card-value {
                font-size: 1.8em;
            }

            .card-value--large {
                font-size: 2.8em;
            }

            .card-event__value {
                font-size: 2.5em;
            }

            .weather-grid {
                grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
                gap: 8px;
            }

            .card-weather {
                padding: 8px;
                border-radius: 8px;
            }

            .card-weather__time {
                font-size: 0.85em;
            }

            .card-weather__icon {
                font-size: 1.6em;
            }

            .card-weather__temp {
                font-size: 0.95em;
            }

            .card-weather__chance {
                font-size: 0.8em;
            }

            .card-weather__precip {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Godstow River Tracker</h1>
            <p class="subtitle">Real-time River Conditions</p>
            <p class="header-updated" id="header-last-updated"></p>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading river data...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="stale-warning" class="stale-warning" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="card">
                <h3>OURCS Flag Status</h3>
                <div class="card-grid card-grid--2col">
                    <div class="card-secondary" style="text-align: center;">
                        <div class="card-label">Godstow</div>
                        <div class="flag-item-status" id="ourcs-godstow-emoji">--</div>
                        <div class="flag-item-text" id="ourcs-godstow-text">--</div>
                        <div class="flag-item-meta" id="ourcs-godstow-meta"></div>
                    </div>
                    <div class="card-secondary" style="text-align: center;">
                        <div class="card-label">Isis</div>
                        <div class="flag-item-status" id="ourcs-isis-emoji">--</div>
                        <div class="flag-item-text" id="ourcs-isis-text">--</div>
                        <div class="flag-item-meta" id="ourcs-isis-meta"></div>
                    </div>
                </div>
            </div>

            <div class="card" style="text-align: center;">
                <h3>Current Godstow Differential</h3>
                <div class="card-grid card-grid--2col" style="align-items: center;">
                    <div>
                        <div class="flag-display" id="flag-status">--</div>
                        <div class="flag-text" id="flag-text">--</div>
                        <div class="flag-description" id="flag-description">--</div>
                        <div style="margin-top: 20px; font-size: 1em;">
                            <a href="#flow-data" class="nav-link">View detailed flow data ‚Üí</a>
                        </div>
                    </div>
                    <div class="card-secondary" style="text-align: center;">
                        <div class="card-label">Godstow Differential</div>
                        <div class="card-value card-value--large" id="flow">--</div>
                        <div class="flow-trend" id="flow-trend"></div>
                    </div>
                </div>

                <div class="card-grid card-grid--2col" style="margin-top: 30px;">
                    <div class="card-secondary card-secondary--compact" style="text-align: center;">
                        <div class="card-label">24h Rainfall</div>
                        <div class="card-value"><span id="rainfall-24h">--</span> mm</div>
                    </div>
                    <div class="card-secondary card-secondary--compact" style="text-align: center;">
                        <div class="card-label">7d Rainfall</div>
                        <div class="card-value"><span id="rainfall-7d">--</span> mm</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Weather Forecast</h3>
                <div class="card-grid card-grid--2col" style="margin-bottom: 25px;">
                    <div class="card-secondary card-secondary--compact" style="text-align: center;">
                        <div class="card-label">Predicted 24h Rainfall</div>
                        <div class="card-value card-value--accent" id="predicted-rainfall-24h">--</div>
                    </div>
                    <div class="card-secondary card-secondary--compact" style="text-align: center;">
                        <div class="card-label">Predicted 3d Rainfall</div>
                        <div class="card-value card-value--accent" id="predicted-rainfall-3d">--</div>
                    </div>
                </div>
                <div id="weather-forecast" class="weather-grid">
                    <!-- Weather forecast will be inserted here -->
                </div>
            </div>

            <div class="card">
                <h3>Upcoming Events</h3>
                <div class="card-grid card-grid--2col" style="margin-top: 20px;">
                    <div class="card-event card-event--dark">
                        <div class="card-event__value" id="countdown-1-days">--</div>
                        <div class="card-event__label" id="countdown-1-label">Event 1</div>
                    </div>
                    <div class="card-event card-event--red">
                        <div class="card-event__value" id="countdown-2-days">--</div>
                        <div class="card-event__label" id="countdown-2-label">Event 2</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Info</h3>
                <div>
                    <strong>Flag Status:</strong><br>
                    üü© Green Flag (Flow under 0.45): No restrictions<br>
                    üüß Amber Flag (Flow 0.45-0.75): X/S-Status coxes only<br>
                    üü• Red Flag (Flow above 0.75): No crews<br><br>
                    <strong>Flow:</strong> The adjusted river differential between Godstow and Osney locks, accounting for the 1.63m height difference between measurement points. This represents the actual flow gradient through the stretch.
                </div>

                <p><strong>Data Source:</strong> Environment Agency Real-time Flood Monitoring API and OpenMeteo Ensemble API (DWD ICON Seamless model)</p>
                <p><strong>Weather Forecast:</strong> Precipitation predictions use ensemble forecasts from 40 model members for improved accuracy</p>
                <p><strong>Update Frequency:</strong> Every 15 minutes during daylight hours (6am-9pm UTC), hourly overnight</p>
                <p id="data-timestamp" style="margin-top: 15px; font-style: italic; color: #888;"></p>
            </div>

            <!-- Flow Data Section (shown when #flow-data hash is active) -->
            <div id="flow-data-section" class="page-section">
                <a href="#" class="nav-link" style="margin-bottom: 20px;">&larr; Back to River Tracker</a>

                <div class="card" style="margin-top: 20px;">
                    <h3>Farmoor Flow - Past 14 Days</h3>
                    <div class="chart-container">
                        <canvas id="farmoor-chart"></canvas>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="https://www.gaugemap.co.uk/#!Map/Summary/1001/1037" target="_blank" style="color: #1a1a2e; text-decoration: none; font-weight: 600;">Current upstream flow data ‚Üí</a>
                    </div>
                </div>

                <div class="card">
                    <h3>Godstow Differential - Past 14 Days</h3>
                    <div class="flag-thresholds">
                        <div class="threshold-item">
                            <div class="threshold-dot" style="background: #28a745;"></div>
                            <span>Green (&lt;0.45)</span>
                        </div>
                        <div class="threshold-item">
                            <div class="threshold-dot" style="background: #fd7e14;"></div>
                            <span>Amber (0.45-0.75)</span>
                        </div>
                        <div class="threshold-item">
                            <div class="threshold-dot" style="background: #dc3545;"></div>
                            <span>Red (&gt;0.75)</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="flow-chart"></canvas>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="https://flags.jamesonlee.com/godstow" target="_blank" style="color: #1a1a2e; text-decoration: none; font-weight: 600;">Godstow flow data ‚Üí</a>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#lock-levels" class="nav-link">View lock level data ‚Üí</a>
                    </div>
                </div>

                <!-- Lock Levels Section (shown when #lock-levels hash is active) -->
                <div id="lock-levels-section" class="page-section">
                    <a href="#flow-data" class="nav-link" style="margin-bottom: 20px;">&larr; Back to Flow Data</a>

                    <div class="card" style="margin-top: 20px;">
                        <h3>Godstow Lock - Downstage Level</h3>
                        <div class="chart-container">
                            <canvas id="godstow-lock-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Osney Lock - Upstage Level</h3>
                        <div class="chart-container">
                            <canvas id="osney-lock-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart instances
        let farmoorChart = null;
        let flowChart = null;
        let godstowLockChart = null;
        let osneyLockChart = null;
        let currentData = null;

        // Hash-based navigation
        function handleHashChange() {
            const hash = window.location.hash;
            const mainCards = document.querySelectorAll('#content > .card:not(#flow-data-section .card):not(#lock-levels-section .card)');
            const flowDataSection = document.getElementById('flow-data-section');
            const lockLevelsSection = document.getElementById('lock-levels-section');

            if (hash === '#flow-data') {
                // Show flow data section, hide others
                mainCards.forEach(card => card.style.display = 'none');
                flowDataSection.classList.add('active');
                lockLevelsSection.classList.remove('active');

                // Create charts if we have data
                if (currentData) {
                    displayFlowDataSection(currentData);
                }
            } else if (hash === '#lock-levels') {
                // Show lock levels section, hide others
                mainCards.forEach(card => card.style.display = 'none');
                flowDataSection.classList.remove('active');
                lockLevelsSection.classList.add('active');

                // Create lock level charts if we have data
                if (currentData) {
                    displayLockLevelsSection(currentData);
                }
            } else {
                // Show main content, hide other sections
                mainCards.forEach(card => card.style.display = 'block');
                flowDataSection.classList.remove('active');
                lockLevelsSection.classList.remove('active');
            }
        }

        window.addEventListener('hashchange', handleHashChange);

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-GB', {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
        }

        function createFarmoorChart(history) {
            const ctx = document.getElementById('farmoor-chart').getContext('2d');

            // Prepare data (history is newest first, so reverse for chart)
            const data = history.slice().reverse().map(r => ({
                x: new Date(r.timestamp),
                y: r.value
            }));

            if (farmoorChart) {
                farmoorChart.destroy();
            }

            farmoorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Flow (m¬≥/s)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'dd MMM'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Flow (m¬≥/s)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString('en-GB', {
                                        dateStyle: 'medium',
                                        timeStyle: 'short'
                                    });
                                },
                                label: function(context) {
                                    return `Flow: ${context.parsed.y.toFixed(2)} m¬≥/s`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createFlowChart(godstowHistory, osneyHistory) {
            const ctx = document.getElementById('flow-chart').getContext('2d');

            // Create a map of osney values by timestamp
            const osneyMap = {};
            osneyHistory.forEach(r => {
                osneyMap[r.timestamp] = r.value;
            });

            // Calculate flow for each godstow reading where we have matching osney
            const flowData = [];
            godstowHistory.slice().reverse().forEach(r => {
                const osneyValue = osneyMap[r.timestamp];
                if (osneyValue !== undefined) {
                    const differential = r.value - osneyValue;
                    const flow = differential - 1.63;
                    flowData.push({
                        x: new Date(r.timestamp),
                        y: flow
                    });
                }
            });

            if (flowChart) {
                flowChart.destroy();
            }

            flowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Flow',
                        data: flowData,
                        borderColor: '#1a1a2e',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;

                            // Create gradient with sharp threshold boundaries
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            const {min, max} = chart.scales.y;
                            const toPos = v => Math.max(0, Math.min(1, (v - min) / (max - min)));

                            const greenPos = toPos(0.45);
                            const redPos = toPos(0.75);

                            gradient.addColorStop(0, 'rgba(40, 167, 69, 0.3)');
                            gradient.addColorStop(greenPos, 'rgba(40, 167, 69, 0.3)');
                            gradient.addColorStop(greenPos, 'rgba(253, 126, 20, 0.3)');
                            gradient.addColorStop(redPos, 'rgba(253, 126, 20, 0.3)');
                            gradient.addColorStop(redPos, 'rgba(220, 53, 69, 0.3)');
                            gradient.addColorStop(1, 'rgba(220, 53, 69, 0.3)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'dd MMM'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Flow (m)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString('en-GB', {
                                        dateStyle: 'medium',
                                        timeStyle: 'short'
                                    });
                                },
                                label: function(context) {
                                    const flow = context.parsed.y;
                                    let status = 'Green';
                                    if (flow > 0.75) status = 'Red';
                                    else if (flow >= 0.45) status = 'Amber';
                                    return `Flow: ${flow.toFixed(3)} (${status})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createGodstowLockChart(history) {
            const ctx = document.getElementById('godstow-lock-chart').getContext('2d');

            // Prepare data (history is newest first, so reverse for chart)
            const data = history.slice().reverse().map(r => ({
                x: new Date(r.timestamp),
                y: r.value
            }));

            if (godstowLockChart) {
                godstowLockChart.destroy();
            }

            godstowLockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Level (m)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'dd MMM'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Level (m)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString('en-GB', {
                                        dateStyle: 'medium',
                                        timeStyle: 'short'
                                    });
                                },
                                label: function(context) {
                                    return `Level: ${context.parsed.y.toFixed(3)} m`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createOsneyLockChart(history) {
            const ctx = document.getElementById('osney-lock-chart').getContext('2d');

            // Prepare data (history is newest first, so reverse for chart)
            const data = history.slice().reverse().map(r => ({
                x: new Date(r.timestamp),
                y: r.value
            }));

            if (osneyLockChart) {
                osneyLockChart.destroy();
            }

            osneyLockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Level (m)',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'dd MMM'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Level (m)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString('en-GB', {
                                        dateStyle: 'medium',
                                        timeStyle: 'short'
                                    });
                                },
                                label: function(context) {
                                    return `Level: ${context.parsed.y.toFixed(3)} m`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayLockLevelsSection(data) {
            // Create lock level charts
            if (data.godstow_history && data.godstow_history.length > 0) {
                createGodstowLockChart(data.godstow_history);
            }

            if (data.osney_history && data.osney_history.length > 0) {
                createOsneyLockChart(data.osney_history);
            }
        }

        function displayFlowDataSection(data) {
            // Create charts
            if (data.farmoor_history && data.farmoor_history.length > 0) {
                createFarmoorChart(data.farmoor_history);
            }

            if (data.godstow_history && data.osney_history &&
                data.godstow_history.length > 0 && data.osney_history.length > 0) {
                createFlowChart(data.godstow_history, data.osney_history);
            }
        }

        // Weather code mapping (WMO codes)
        function getWeatherEmoji(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return 'üå®Ô∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return 'üå®Ô∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return '‚òÅÔ∏è';
        }

        function displayWeatherForecast(forecast, ensembleStats) {
            const container = document.getElementById('weather-forecast');
            container.innerHTML = '';

            // Use ensemble rainfall statistics if available
            if (ensembleStats && ensembleStats.mean !== null && ensembleStats.mean !== undefined) {
                const meanText = ensembleStats.mean.toFixed(1);
                const rangeText = `${ensembleStats.p10.toFixed(1)}-${ensembleStats.p90.toFixed(1)}`;
                document.getElementById('predicted-rainfall-24h').innerHTML =
                    `${meanText} mm <span style="font-size: 0.8em; color: #6b7280;">(${rangeText}mm)</span>`;
            } else if (forecast && forecast.length > 0) {
                // Fallback: Calculate total predicted rainfall for 24 hours
                let totalPrecipitation = 0;
                forecast.forEach(hour => {
                    if (hour.precipitation !== null && hour.precipitation !== undefined) {
                        totalPrecipitation += hour.precipitation;
                    }
                });
                document.getElementById('predicted-rainfall-24h').textContent = totalPrecipitation.toFixed(1) + ' mm';
            } else {
                document.getElementById('predicted-rainfall-24h').textContent = '--';
            }

            if (!forecast || forecast.length === 0) {
                container.innerHTML = '<p style="color: #999;">Weather forecast unavailable</p>';
                return;
            }

            forecast.forEach((hour, index) => {
                if (index % 3 !== 0) return; // Show every 3 hours

                const time = new Date(hour.time);
                const hourDiv = document.createElement('div');
                hourDiv.className = 'card-weather';

                // Sum precipitation for the 3-hour period starting from this hour
                let precipSum = 0;
                for (let i = index; i < Math.min(index + 3, forecast.length); i++) {
                    if (forecast[i].precipitation !== null && forecast[i].precipitation !== undefined) {
                        precipSum += forecast[i].precipitation;
                    }
                }
                const precipitation = precipSum > 0 ? precipSum.toFixed(1) + 'mm' : '0.0mm';

                hourDiv.innerHTML = `
                    <div class="card-weather__time">${time.getHours()}:00</div>
                    <div class="card-weather__icon">${getWeatherEmoji(hour.weather_code)}</div>
                    <div class="card-weather__temp">${hour.temperature ? Math.round(hour.temperature) + '¬∞C' : '--'}</div>
                    <div class="card-weather__chance">${hour.precipitation_probability ? hour.precipitation_probability + '%' : '--'}</div>
                    <div class="card-weather__precip">${precipitation}</div>
                `;

                container.appendChild(hourDiv);
            });
        }

        function updateCountdowns() {
            const torpids = new Date('2026-03-04T00:00:00');
            const summerEights = new Date('2026-05-27T00:00:00');

            const now = new Date();
            now.setHours(0, 0, 0, 0); // Reset to start of day for accurate day count

            const daysTorpids = Math.ceil((torpids - now) / (1000 * 60 * 60 * 24));
            const daysSummerEights = Math.ceil((summerEights - now) / (1000 * 60 * 60 * 24));

            document.getElementById('countdown-1-days').textContent = daysTorpids > 0 ? daysTorpids : 0;
            document.getElementById('countdown-1-label').textContent = 'Days until Torpids';

            document.getElementById('countdown-2-days').textContent = daysSummerEights > 0 ? daysSummerEights : 0;
            document.getElementById('countdown-2-label').textContent = 'Days until Summer Eights';
        }

        async function loadData() {
            try {
                const response = await fetch('data/current.json?t=' + Date.now());

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Save to localStorage on successful fetch
                localStorage.setItem('riverData', JSON.stringify(data));
                localStorage.setItem('riverDataTimestamp', Date.now().toString());

                // Store data globally for hash navigation
                currentData = data;

                // Display the data
                displayData(data);

                // Handle hash navigation after data is loaded
                handleHashChange();

                // Hide loading, show content, hide warnings
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('stale-warning').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);

                // Try to load from localStorage
                const cachedData = localStorage.getItem('riverData');
                const cachedTimestamp = localStorage.getItem('riverDataTimestamp');

                if (cachedData && cachedTimestamp) {
                    console.log('Using cached data');
                    const data = JSON.parse(cachedData);
                    currentData = data;
                    const cacheAge = Date.now() - parseInt(cachedTimestamp);
                    const hoursOld = Math.floor(cacheAge / (1000 * 60 * 60));
                    const minutesOld = Math.floor((cacheAge % (1000 * 60 * 60)) / (1000 * 60));

                    // Display the cached data
                    displayData(data);
                    handleHashChange();

                    // Show stale warning
                    const warningEl = document.getElementById('stale-warning');
                    let ageText = hoursOld > 0 ? `${hoursOld}h ${minutesOld}m` : `${minutesOld}m`;
                    warningEl.innerHTML = `‚ö†Ô∏è Showing cached data (${ageText} old) - unable to fetch latest update`;
                    warningEl.style.display = 'block';

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                } else {
                    // No cached data available
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').innerHTML = `
                        <strong>‚ö†Ô∏è Unable to load river data</strong><br>
                        ${error.message}<br>
                        <small>No cached data available. The data file may not exist yet.</small>
                    `;
                }
            }
        }

        function getFlagEmoji(statusText) {
                // Map OURCS flag status to emoji
                const lower = statusText.toLowerCase();
                if (lower.includes('green')) return 'üü©';
                if (lower.includes('amber')) return 'üüß';
                if (lower.includes('red')) return 'üü•';
                if (lower.includes('blue')) return 'üü¶';  // All blues use blue square
                if (lower.includes('grey') || lower.includes('gray')) return '‚¨ú';
                return '--';
        }

        function displayOURCSFlags(data) {
                // Display OURCS Godstow flag
                if (data.ourcs_godstow_flag) {
                    const godstow = data.ourcs_godstow_flag;
                    const godstowEmoji = getFlagEmoji(godstow.status_text);
                    document.getElementById('ourcs-godstow-emoji').textContent = godstowEmoji;
                    document.getElementById('ourcs-godstow-text').textContent = godstow.status_text;

                    if (godstow.set_date) {
                        const setDate = new Date(godstow.set_date);
                        document.getElementById('ourcs-godstow-meta').textContent =
                            `Updated ${setDate.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'})}`;
                    }
                }

                // Display OURCS Isis flag
                if (data.ourcs_isis_flag) {
                    const isis = data.ourcs_isis_flag;
                    const isisEmoji = getFlagEmoji(isis.status_text);
                    document.getElementById('ourcs-isis-emoji').textContent = isisEmoji;
                    document.getElementById('ourcs-isis-text').textContent = isis.status_text;

                    if (isis.set_date) {
                        const setDate = new Date(isis.set_date);
                        document.getElementById('ourcs-isis-meta').textContent =
                            `Updated ${setDate.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'})}`;
                    }
                }
        }

        function displayData(data) {
                // Display OURCS flags
                displayOURCSFlags(data);

                // Calculate flow (adjusted differential)
                let flow = null;
                if (data.differential !== null) {
                    flow = data.differential - 1.63;
                    document.getElementById('flow').textContent = flow.toFixed(3);

                    // Determine flag status
                    let flagEmoji, flagText, flagDescription, flagColor;
                    if (flow > 0.75) {
                        flagEmoji = 'üü•';
                        flagText = 'Red';
                        flagDescription = 'No crews';
                        flagColor = '#dc3545';
                    } else if (flow < 0.45) {
                        flagEmoji = 'üü©';
                        flagText = 'Green';
                        flagDescription = 'No restrictions';
                        flagColor = '#28a745';
                    } else {
                        flagEmoji = 'üüß';
                        flagText = 'Amber';
                        flagDescription = 'X/S-Status coxes only';
                        flagColor = '#fd7e14';
                    }

                    document.getElementById('flag-status').textContent = flagEmoji;
                    document.getElementById('flag-text').textContent = flagText;
                    document.getElementById('flag-text').style.color = flagColor;
                    document.getElementById('flag-description').textContent = flagDescription;
                } else {
                    document.getElementById('flow').textContent = 'N/A';
                    document.getElementById('flag-status').textContent = '--';
                    document.getElementById('flag-text').textContent = '--';
                    document.getElementById('flag-description').textContent = '--';
                }

                // Display flow trend - ensure it shows even if null initially
                const trendElement = document.getElementById('flow-trend');
                if (data.flow_trend) {
                    let trendIcon, trendText, trendColor;
                    if (data.flow_trend === 'increasing') {
                        trendIcon = '‚Üë';
                        trendText = 'Increasing';
                        trendColor = '#dc3545';
                    } else if (data.flow_trend === 'decreasing') {
                        trendIcon = '‚Üì';
                        trendText = 'Decreasing';
                        trendColor = '#28a745';
                    } else if (data.flow_trend === 'level') {
                        trendIcon = '‚Üí';
                        trendText = 'Level';
                        trendColor = '#666';
                    }
                    trendElement.innerHTML = `<span class="trend-icon" style="color: ${trendColor};">${trendIcon}</span><span style="color: ${trendColor};">${trendText}</span>`;
                } else {
                    // Show a message if trend not yet available
                    trendElement.innerHTML = '<span style="color: #999; font-size: 0.9em;">Trend available after next update</span>';
                }

                document.getElementById('rainfall-24h').textContent =
                    data.rainfall_24h ? data.rainfall_24h.toFixed(1) : '0.0';
                document.getElementById('rainfall-7d').textContent =
                    data.rainfall_7d ? data.rainfall_7d.toFixed(1) : '0.0';

                // Display weather forecast with ensemble rainfall if available
                const ensemble24h = (data.ensemble_rainfall_24h_mean !== null && data.ensemble_rainfall_24h_mean !== undefined) ? {
                    mean: data.ensemble_rainfall_24h_mean,
                    p10: data.ensemble_rainfall_24h_p10,
                    p90: data.ensemble_rainfall_24h_p90
                } : null;
                displayWeatherForecast(data.weather_forecast || [], ensemble24h);

                // Display 3-day rainfall forecast - use ensemble if available
                if (data.ensemble_rainfall_72h_mean !== null && data.ensemble_rainfall_72h_mean !== undefined) {
                    const meanText = data.ensemble_rainfall_72h_mean.toFixed(1);
                    const rangeText = `${data.ensemble_rainfall_72h_p10.toFixed(1)}-${data.ensemble_rainfall_72h_p90.toFixed(1)}`;
                    document.getElementById('predicted-rainfall-3d').innerHTML =
                        `${meanText} mm <span style="font-size: 0.8em; color: #6b7280;">(${rangeText}mm)</span>`;
                } else {
                    const forecast3d = data.rainfall_forecast_3d || [];
                    if (forecast3d.length > 0) {
                        const total3d = forecast3d.reduce((sum, day) => sum + (day.precipitation || 0), 0);
                        document.getElementById('predicted-rainfall-3d').textContent = total3d.toFixed(1) + ' mm';
                    } else {
                        document.getElementById('predicted-rainfall-3d').textContent = '--';
                    }
                }

                // Display countdowns
                updateCountdowns();

                // Update last updated time in header
                const lastUpdated = new Date(data.last_updated);
                document.getElementById('header-last-updated').textContent =
                    `Last updated: ${lastUpdated.toLocaleString('en-GB', {
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    })}`;

                // Update data timestamp (when measurements were taken)
                if (data.godstow_lock && data.godstow_lock.timestamp) {
                    const measurementTime = new Date(data.godstow_lock.timestamp);
                    document.getElementById('data-timestamp').textContent =
                        `Measurements from: ${measurementTime.toLocaleString('en-GB', {
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        })}`;
                } else if (data.osney_lock && data.osney_lock.timestamp) {
                    const measurementTime = new Date(data.osney_lock.timestamp);
                    document.getElementById('data-timestamp').textContent =
                        `Measurements from: ${measurementTime.toLocaleString('en-GB', {
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        })} (Godstow data unavailable)`;
                }
        }

        // Load data when page loads
        loadData();
        
        // Refresh data every 5 minutes (in case it updates)
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>