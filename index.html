<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godstow River Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 30px 20px;
            color: #1f2937;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.4em;
            font-weight: 700;
            letter-spacing: -1px;
            color: #1a1a2e;
        }

        .header-updated {
            font-size: 0.85em;
            color: #9ca3af;
            margin-top: 6px;
        }

        .loading {
            text-align: center;
            padding: 80px;
            font-size: 1.2em;
            color: #6b7280;
        }

        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #1a1a2e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #fecaca;
        }

        .stale-warning {
            background: #fffbeb;
            color: #92400e;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #fcd34d;
            font-size: 0.9em;
        }

        /* Two-column grid — paired rows */
        .page-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 0 40px;
            align-items: start;
        }

        .grid-row {
            display: contents;
        }

        .section-label {
            font-size: 0.75em;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .section-divider {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 24px 0;
        }

        /* Left column: values */
        .left-col {
            padding: 0;
        }

        .flow-value-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .flag-description {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 6px;
        }

        .ourcs-flags {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 16px;
            font-size: 1em;
            color: #4b5563;
        }

        .ourcs-flag-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .value-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 6px 0;
        }

        .value-label {
            font-size: 0.9em;
            color: #6b7280;
        }

        .value-number {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
        }

        .value-big {
            font-size: 2.2em;
            font-weight: 700;
            color: #1a1a2e;
            text-align: center;
            padding: 4px 0;
            line-height: 1;
        }

        .flow-trend {
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 4px;
            margin-bottom: 8px;
        }


        /* Right column: charts */
        .right-col {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .chart-block {
            position: relative;
        }

        .chart-title {
            font-size: 0.75em;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 6px;
            font-size: 0.8em;
            color: #6b7280;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Full-width sections below the grid */
        .full-width {
            margin-top: 30px;
        }

        .weather-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -4px;
            padding: 0 4px 8px;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .weather-grid--inline {
            display: flex;
            gap: 6px;
        }

        .weather-grid--inline .weather-cell {
            min-width: 65px;
            flex-shrink: 0;
        }

        .weather-cell {
            text-align: center;
            padding: 10px 4px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }

        .weather-cell__time {
            font-size: 0.8em;
            color: #6b7280;
            font-weight: 600;
        }

        .weather-cell__icon {
            font-size: 1.8em;
            margin: 4px 0;
        }

        .weather-cell__temp {
            font-weight: 700;
            font-size: 0.95em;
        }

        .weather-cell__precip {
            font-size: 0.75em;
            color: #10b981;
            font-weight: 600;
            margin-top: 2px;
        }


        .info-text {
            font-size: 0.8em;
            color: #9ca3af;
            line-height: 1.6;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .info-text a {
            color: #6b7280;
        }

        @media (max-width: 900px) {
            .page-grid {
                grid-template-columns: 1fr;
            }

            h1 { font-size: 1.8em; }

            .chart-container { height: 220px; }

            .weather-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Godstow River Tracker</h1>
            <p class="header-updated" id="header-last-updated"></p>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading river data...
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="stale-warning" class="stale-warning" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="page-grid">
                <!-- ROW 1: Flag status + predictions | Combined chart -->
                <div class="left-col" style="padding-bottom:24px;">
                    <div class="section-label" style="text-align:center;">OURCS Flags</div>
                    <div class="ourcs-flags" style="margin-top:4px;">
                        <div class="ourcs-flag-item">
                            <span id="ourcs-godstow-emoji" style="font-size:1.8em;">--</span>
                            <span>Godstow</span>
                        </div>
                        <div class="ourcs-flag-item">
                            <span id="ourcs-isis-emoji" style="font-size:1.8em;">--</span>
                            <span>Isis</span>
                        </div>
                    </div>

                    <hr class="section-divider">

                    <div class="section-label" style="text-align:center;">Godstow Differential</div>
                    <div class="flow-value-row">
                        <span id="flag-status" style="font-size:1.6em;">--</span>
                        <span class="value-big" id="flow">--</span>
                    </div>
                    <div class="flag-description" id="flag-description" style="text-align:center;">--</div>
                    <div class="flow-trend" id="flow-trend"></div>

                    <hr class="section-divider">

                    <div class="section-label">Prediction (No further rain)</div>
                    <div id="predictions-content">
                        <!-- Dynamic prediction content -->
                    </div>

                    <hr class="section-divider">

                </div>
                <div class="right-col" style="padding-bottom:24px;">
                    <div class="chart-block">
                        <div class="chart-title">Godstow Differential &mdash; 14 day history &amp; forecast (assuming no rain)</div>
                        <div class="chart-legend">
                            <div class="legend-item"><div class="legend-dot" style="background:#28a745;"></div> Green (&lt;0.45)</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#fd7e14;"></div> Amber (0.45-0.75)</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#dc3545;"></div> Red (&gt;0.75)</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="combined-chart"></canvas>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:8px;font-size:0.85em;">
                        <a href="https://robertdoanesolomon.github.io/Flag_Predictor/" target="_blank" style="color:#6b7280;">Rob's AI-powered forecast (with rainfall) &rarr;</a>
                    </div>
                </div>

                <!-- ROW 3: Rainfall + Weather forecast -->
                <div class="left-col" style="padding-bottom:24px;">
                    <div class="section-label">Local Rainfall</div>
                    <div class="value-row">
                        <span class="value-label">Last 24h</span>
                        <span class="value-number"><span id="rainfall-24h">--</span> mm</span>
                    </div>
                    <div class="value-row">
                        <span class="value-label">Last 7 days</span>
                        <span class="value-number"><span id="rainfall-7d">--</span> mm</span>
                    </div>

                    <div class="section-label" style="margin-top: 12px;">Average Upstream Rainfall</div>
                    <div class="value-row">
                        <span class="value-label">Last 24h</span>
                        <span class="value-number"><span id="upstream-rainfall-24h">--</span> mm</span>
                    </div>
                    <div class="value-row">
                        <span class="value-label">Last 7 days</span>
                        <span class="value-number"><span id="upstream-rainfall-7d">--</span> mm</span>
                    </div>

                    <div class="section-label" style="margin-top: 12px;">Forecast Rainfall</div>
                    <div class="value-row">
                        <span class="value-label">Next 24h</span>
                        <span class="value-number" id="predicted-rainfall-24h">--</span>
                    </div>
                    <div class="value-row">
                        <span class="value-label">Next 3d</span>
                        <span class="value-number" id="predicted-rainfall-3d">--</span>
                    </div>
                </div>
                <div class="right-col" style="padding-bottom:24px;">
                    <div class="chart-title">24h Weather Forecast</div>
                    <div id="weather-forecast" class="weather-grid"></div>
                </div>
            </div>

            <!-- Full-width: info -->
            <div class="info-text">
                Flag status: Green (flow &lt;0.45) no restrictions, Amber (0.45-0.75) experienced coxes only, Red (&gt;0.75) no crews.<br>
                Flow is the adjusted differential between Godstow and Osney locks minus the 1.63m height offset.<br>
                Predictions assume no additional rainfall and are modelled on observed daily drop in levels at Godstow Lock.<br>
                Data from <a href="https://environment.data.gov.uk/flood-monitoring/doc/reference" target="_blank">EA Flood Monitoring API</a> and <a href="https://open-meteo.com/" target="_blank">Open-Meteo</a>.<br>
                Source code on <a href="https://github.com/toby-tcell/godstow-river-flow" target="_blank">GitHub</a>.<br>
                Updates detailed on <a href="https://tobywhitehead.substack.com" target="_blank">Substack</a>.<br>
                <span id="data-timestamp"></span>
            </div>
        </div>
    </div>

    <script>
        let combinedChart = null;
        let currentData = null;
        let predictionModel = null;

        const MEADOW_FLOOD_LEVEL = 2.57;

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString('en-GB', {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
        }

        // ---- Prediction model: godstow drop-rate projection ----

        function projectGodstowLevel(currentLevel, model, days) {
            const bins = model.godstow_decay_rates.bins;
            let level = currentLevel;
            const points = [{day: 0, level: level}];

            for (let d = 1; d <= days; d++) {
                let dropRate = 0;
                for (const bin of bins) {
                    if (level >= bin.min_level && level < bin.max_level) {
                        dropRate = bin.median_drop_mm_per_day;
                        break;
                    }
                }
                level -= dropRate / 1000;
                level = Math.max(level, 1.4);
                points.push({day: d, level: level});
            }
            return points;
        }

        function projectDifferential(godstowPoints, avgOsney) {
            return godstowPoints.map(p => ({
                day: p.day,
                diff: (p.level - avgOsney) - 1.63
            }));
        }

        function daysToThreshold(diffPoints, threshold) {
            for (let i = 1; i < diffPoints.length; i++) {
                if (diffPoints[i].diff <= threshold) {
                    // Interpolate between i-1 and i
                    const prev = diffPoints[i - 1];
                    const curr = diffPoints[i];
                    const frac = (prev.diff - threshold) / (prev.diff - curr.diff);
                    return prev.day + frac;
                }
            }
            return null;
        }

        function displayPredictions(data, model) {
            const container = document.getElementById('predictions-content');
            const currentFlow = data.flow;
            const godstowLevel = data.godstow_lock ? data.godstow_lock.level : null;

            if (currentFlow == null || !model || !model.godstow_decay_rates || godstowLevel == null) {
                container.innerHTML = '<span class="value-label">Prediction data unavailable</span>';
                return;
            }

            const greenThreshold = model.thresholds.green_amber_flow;
            const amberThreshold = model.thresholds.amber_red_flow;
            const avgOsney = model.godstow_decay_rates.avg_osney;

            const godstowPoints = projectGodstowLevel(godstowLevel, model, 30);
            const diffPoints = projectDifferential(godstowPoints, avgOsney);

            const toAmber = currentFlow > amberThreshold ? daysToThreshold(diffPoints, amberThreshold) : null;
            const toGreen = currentFlow > greenThreshold ? daysToThreshold(diffPoints, greenThreshold) : null;

            let html = '';
            if (currentFlow <= greenThreshold) {
                html = '<div class="value-row"><span class="value-label">Status</span><span class="value-number" style="color:#28a745;">Currently Green</span></div>';
            } else {
                if (toAmber !== null) {
                    html += `<div class="value-row"><span class="value-label">Days to Amber</span><span class="value-number" style="color:#fd7e14; font-weight:700;">${Math.ceil(toAmber)}</span></div>`;
                }
                if (toGreen !== null) {
                    html += `<div class="value-row"><span class="value-label">Days to Green</span><span class="value-number" style="color:#28a745; font-weight:700;">${Math.ceil(toGreen)}</span></div>`;
                } else if (currentFlow > greenThreshold) {
                    html += `<div class="value-row"><span class="value-label">Days to Green</span><span class="value-number" style="color:#6b7280;">30+</span></div>`;
                }
            }
            container.innerHTML = html;

            createCombinedChart(data, diffPoints);
        }

        function createCombinedChart(data, diffPoints) {
            const ctx = document.getElementById('combined-chart').getContext('2d');

            // Build full 14-day history from godstow + osney, downsampled to ~hourly
            const osneyMap = {};
            if (data.osney_history) {
                data.osney_history.forEach(r => { osneyMap[r.timestamp] = r.value; });
            }

            const allHistoryData = [];
            if (data.godstow_history) {
                data.godstow_history.slice().reverse().forEach(r => {
                    const osneyValue = osneyMap[r.timestamp];
                    if (osneyValue !== undefined) {
                        allHistoryData.push({ x: new Date(r.timestamp), y: (r.value - osneyValue) - 1.63 });
                    }
                });
            }

            // Downsample history to ~hourly (keep every 4th point from 15-min data)
            const historyData = allHistoryData.filter((_, i) => i % 4 === 0 || i === allHistoryData.length - 1);

            const now = new Date();
            const chartStart = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
            const chartEnd = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);

            // Build predicted line from diffPoints (day-by-day projection)
            const predictedData = diffPoints.map(p => ({
                x: new Date(now.getTime() + p.day * 24 * 60 * 60 * 1000),
                y: Math.max(p.diff, 0)
            }));

            const greenLine = [{ x: chartStart, y: 0.45 }, { x: chartEnd, y: 0.45 }];
            const amberLine = [{ x: chartStart, y: 0.75 }, { x: chartEnd, y: 0.75 }];
            const yMax = Math.max(data.flow || 0, 1.0);
            const nowLine = [{ x: now, y: 0 }, { x: now, y: yMax * 1.1 }];

            if (combinedChart) combinedChart.destroy();

            const gradientFn = (opacity) => function(context) {
                const chart = context.chart;
                const {ctx: c, chartArea} = chart;
                if (!chartArea) return null;
                const gradient = c.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                const {min, max} = chart.scales.y;
                const toPos = v => Math.max(0, Math.min(1, (v - min) / (max - min)));
                const gp = toPos(0.45), rp = toPos(0.75);
                gradient.addColorStop(0, `rgba(40,167,69,${opacity})`);
                gradient.addColorStop(gp, `rgba(40,167,69,${opacity})`);
                gradient.addColorStop(gp, `rgba(253,126,20,${opacity})`);
                gradient.addColorStop(rp, `rgba(253,126,20,${opacity})`);
                gradient.addColorStop(rp, `rgba(220,53,69,${opacity})`);
                gradient.addColorStop(1, `rgba(220,53,69,${opacity})`);
                return gradient;
            };

            combinedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Actual',
                            data: historyData,
                            borderColor: '#1a1a2e',
                            backgroundColor: gradientFn(0.25),
                            fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2, order: 2
                        },
                        {
                            label: 'Predicted',
                            data: predictedData,
                            borderColor: '#6b7280',
                            backgroundColor: gradientFn(0.12),
                            fill: true, borderDash: [5, 5], tension: 0.1, pointRadius: 0, borderWidth: 2, order: 3
                        },
                        { label: 'Green', data: greenLine, borderColor: 'rgba(40,167,69,0.5)', borderDash: [5,5], borderWidth: 1, pointRadius: 0, fill: false, order: 1 },
                        { label: 'Amber', data: amberLine, borderColor: 'rgba(253,126,20,0.5)', borderDash: [5,5], borderWidth: 1, pointRadius: 0, fill: false, order: 1 },
                        { label: 'Now', data: nowLine, borderColor: 'rgba(107,114,128,0.3)', borderDash: [3,3], borderWidth: 1, pointRadius: 0, fill: false, order: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'nearest', axis: 'x' },
                    scales: {
                        x: { type: 'time', min: chartStart, max: chartEnd, time: { unit: 'day', displayFormats: { day: 'dd MMM' } } },
                        y: { title: { display: true, text: 'Flow (m)' }, beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { filter: item => item.text === 'Actual' || item.text === 'Predicted' } },
                        tooltip: {
                            filter: item => !['Now','Green','Amber'].includes(item.dataset.label),
                            callbacks: {
                                title: ctx => formatTimestamp(ctx[0].parsed.x),
                                label: ctx => {
                                    const f = ctx.parsed.y;
                                    const s = f > 0.75 ? 'Red' : f >= 0.45 ? 'Amber' : 'Green';
                                    return `${ctx.dataset.label}: ${f.toFixed(3)}m (${s})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ---- Weather ----

        function getWeatherEmoji(code) {
            if (code === 0) return '\u2600\uFE0F';
            if (code <= 3) return '\u26C5';
            if (code <= 48) return '\uD83C\uDF2B\uFE0F';
            if (code <= 67) return '\uD83C\uDF27\uFE0F';
            if (code <= 77) return '\uD83C\uDF28\uFE0F';
            if (code <= 82) return '\uD83C\uDF27\uFE0F';
            if (code <= 86) return '\uD83C\uDF28\uFE0F';
            if (code <= 99) return '\u26C8\uFE0F';
            return '\u2601\uFE0F';
        }

        function displayWeatherForecast(forecast, ensembleStats) {
            const container = document.getElementById('weather-forecast');
            container.innerHTML = '';

            if (ensembleStats && ensembleStats.mean !== null && ensembleStats.mean !== undefined) {
                const el = document.getElementById('predicted-rainfall-24h');
                el.innerHTML = `${ensembleStats.mean.toFixed(1)} mm <span style="font-size:0.75em;color:#9ca3af;">(${ensembleStats.p10.toFixed(1)}-${ensembleStats.p90.toFixed(1)})</span>`;
            } else if (forecast && forecast.length > 0) {
                let total = 0;
                forecast.forEach(h => { if (h.precipitation != null) total += h.precipitation; });
                document.getElementById('predicted-rainfall-24h').textContent = total.toFixed(1) + ' mm';
            }

            if (!forecast || forecast.length === 0) {
                container.innerHTML = '<span style="color:#9ca3af;font-size:0.85em;">Forecast unavailable</span>';
                return;
            }

            forecast.forEach((hour, i) => {
                if (i % 2 !== 0) return;
                const time = new Date(hour.time);
                let precipSum = 0;
                for (let j = i; j < Math.min(i + 2, forecast.length); j++) {
                    if (forecast[j].precipitation != null) precipSum += forecast[j].precipitation;
                }
                const div = document.createElement('div');
                div.className = 'weather-cell';
                div.innerHTML = `
                    <div class="weather-cell__time">${time.getHours()}:00</div>
                    <div class="weather-cell__icon">${getWeatherEmoji(hour.weather_code)}</div>
                    <div class="weather-cell__temp">${hour.temperature ? Math.round(hour.temperature) + '\u00b0C' : '--'}</div>
                    <div class="weather-cell__precip">${precipSum > 0 ? precipSum.toFixed(1) + 'mm' : '0mm'}</div>
                `;
                container.appendChild(div);
            });
        }

        // ---- Data loading ----

        function getFlagEmoji(statusText) {
            const lower = statusText.toLowerCase();
            if (lower.includes('green')) return '\uD83D\uDFE9';
            if (lower.includes('amber')) return '\uD83D\uDFE7';
            if (lower.includes('red')) return '\uD83D\uDFE5';
            if (lower.includes('blue')) return '\uD83D\uDFE6';
            return '--';
        }

        function displayData(data) {
            // OURCS flags
            if (data.ourcs_godstow_flag) {
                document.getElementById('ourcs-godstow-emoji').textContent = getFlagEmoji(data.ourcs_godstow_flag.status_text);
            }
            if (data.ourcs_isis_flag) {
                document.getElementById('ourcs-isis-emoji').textContent = getFlagEmoji(data.ourcs_isis_flag.status_text);
            }

            // Flow
            let flow = null;
            if (data.differential !== null) {
                flow = data.differential - 1.63;
                document.getElementById('flow').textContent = flow.toFixed(3);

                let flagEmoji, flagText, flagDesc, flagColor;
                if (flow > 0.75) { flagEmoji = '\uD83D\uDFE5'; flagText = 'Red'; flagDesc = 'No crews'; flagColor = '#dc3545'; }
                else if (flow < 0.45) { flagEmoji = '\uD83D\uDFE9'; flagText = 'Green'; flagDesc = 'No restrictions'; flagColor = '#28a745'; }
                else { flagEmoji = '\uD83D\uDFE7'; flagText = 'Amber'; flagDesc = 'X/S-Status coxes only'; flagColor = '#fd7e14'; }

                document.getElementById('flag-status').textContent = flagEmoji;
                document.getElementById('flag-description').textContent = `${flagText} — ${flagDesc}`;
                document.getElementById('flag-description').style.color = flagColor;
            }

            // Flow trend
            const trendEl = document.getElementById('flow-trend');
            if (data.flow_trend) {
                let icon, text, color;
                if (data.flow_trend === 'Rising') { icon = '\u2191'; text = 'Increasing'; color = '#dc3545'; }
                else if (data.flow_trend === 'Falling') { icon = '\u2193'; text = 'Decreasing'; color = '#28a745'; }
                else { icon = '\u2192'; text = 'Level'; color = '#6b7280'; }
                trendEl.innerHTML = `<span style="color:${color};">${icon} ${text}</span>`;
            }

            // Rainfall
            document.getElementById('rainfall-24h').textContent = (data.rainfall_24h || 0).toFixed(1);
            document.getElementById('rainfall-7d').textContent = (data.rainfall_7d || 0).toFixed(1);
            document.getElementById('upstream-rainfall-24h').textContent = (data.upstream_rainfall_24h || 0).toFixed(1);
            document.getElementById('upstream-rainfall-7d').textContent = (data.upstream_rainfall_7d || 0).toFixed(1);

            // Weather
            const ensemble24h = (data.ensemble_rainfall_24h_mean != null) ? { mean: data.ensemble_rainfall_24h_mean, p10: data.ensemble_rainfall_24h_p10, p90: data.ensemble_rainfall_24h_p90 } : null;
            displayWeatherForecast(data.weather_forecast || [], ensemble24h);

            // 3-day forecast
            if (data.ensemble_rainfall_72h_mean != null) {
                document.getElementById('predicted-rainfall-3d').innerHTML = `${data.ensemble_rainfall_72h_mean.toFixed(1)} mm <span style="font-size:0.75em;color:#9ca3af;">(${data.ensemble_rainfall_72h_p10.toFixed(1)}-${data.ensemble_rainfall_72h_p90.toFixed(1)})</span>`;
            } else {
                const f3d = data.rainfall_forecast_3d || [];
                if (f3d.length > 0) {
                    document.getElementById('predicted-rainfall-3d').textContent = f3d.reduce((s, d) => s + (d.precipitation || 0), 0).toFixed(1) + ' mm';
                }
            }

            // Timestamps
            const lastUpdated = new Date(data.last_updated);
            document.getElementById('header-last-updated').textContent = `Updated ${lastUpdated.toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' })}`;
            if (data.godstow_lock && data.godstow_lock.timestamp) {
                document.getElementById('data-timestamp').textContent = `Readings from ${formatTimestamp(data.godstow_lock.timestamp)}.`;
            }

            // Create combined chart
            if (predictionModel) {
                displayPredictions(data, predictionModel);
            }
        }

        async function loadData() {
            try {
                const [dataResponse, modelResponse] = await Promise.all([
                    fetch('data/current.json?t=' + Date.now()),
                    fetch('data/prediction_model.json?t=' + Date.now())
                ]);

                if (!dataResponse.ok) throw new Error(`HTTP ${dataResponse.status}`);

                const data = await dataResponse.json();
                if (modelResponse.ok) predictionModel = await modelResponse.json();

                localStorage.setItem('riverData', JSON.stringify(data));
                localStorage.setItem('riverDataTimestamp', Date.now().toString());
                if (predictionModel) localStorage.setItem('predictionModel', JSON.stringify(predictionModel));

                currentData = data;
                displayData(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('stale-warning').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                const cached = localStorage.getItem('riverData');
                const cachedTs = localStorage.getItem('riverDataTimestamp');
                const cachedModel = localStorage.getItem('predictionModel');

                if (cached && cachedTs) {
                    const data = JSON.parse(cached);
                    currentData = data;
                    if (cachedModel) predictionModel = JSON.parse(cachedModel);
                    const age = Date.now() - parseInt(cachedTs);
                    const h = Math.floor(age / 3600000), m = Math.floor((age % 3600000) / 60000);

                    displayData(data);

                    const w = document.getElementById('stale-warning');
                    w.textContent = `Showing cached data (${h > 0 ? h + 'h ' : ''}${m}m old)`;
                    w.style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                } else {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = 'Unable to load river data. No cached data available.';
                }
            }
        }

        loadData();
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
