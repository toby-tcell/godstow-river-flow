<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCBC River Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            color: #666;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .flag-display {
            font-size: 8em;
            margin: 20px 0;
            line-height: 1;
        }

        .flag-text {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .flag-description {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 30px;
        }

        .flow-section {
            margin: 40px 0;
            padding: 30px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .flow-label {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        .flow-value {
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }

        .flow-trend {
            font-size: 1.2em;
            margin-top: 10px;
            color: #666;
        }

        .trend-icon {
            font-size: 1.3em;
            margin-right: 5px;
        }

        .rainfall-section {
            margin-top: 30px;
            padding: 20px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .rainfall-label {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 5px;
        }

        .rainfall-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.3em;
        }

        .spinner {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #666;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .info-box {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-box h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .last-updated {
            text-align: center;
            color: #666;
            margin-top: 30px;
            font-size: 0.95em;
        }

        .stale-warning {
            background: #fff3cd;
            color: #856404;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .ourcs-flags {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ourcs-flags h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }

        .flags-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .flag-item {
            text-align: center;
            padding: 15px;
            background: #fafafa;
            border-radius: 4px;
        }

        .flag-item-label {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
        }

        .flag-item-status {
            font-size: 3em;
            margin: 10px 0;
        }

        .flag-item-text {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .flag-item-meta {
            font-size: 0.85em;
            color: #888;
            margin-top: 10px;
        }

        .flag-notice {
            font-size: 0.9em;
            color: #856404;
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .highlight {
            background: #f9f9f9;
            border-left: 4px solid #666;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 1em;
            }

            .main-content {
                padding: 20px;
            }

            .main-content > div:first-child {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .flag-display {
                font-size: 5em !important;
                margin: 10px 0 !important;
            }

            .flag-text {
                font-size: 2em !important;
                margin-bottom: 10px !important;
            }

            .flag-description {
                font-size: 1.1em !important;
                margin-bottom: 20px !important;
            }

            .flow-section {
                padding: 20px !important;
            }

            .flow-value {
                font-size: 2.5em !important;
            }

            .flow-trend {
                font-size: 1em !important;
            }

            .main-content > div:nth-child(2) {
                grid-template-columns: 1fr !important;
            }

            .rainfall-label {
                font-size: 1em !important;
            }

            .rainfall-value {
                font-size: 1.5em !important;
            }

            .info-box {
                padding: 15px;
            }

            .info-box h3 {
                font-size: 1.2em;
            }

            .info-box p {
                font-size: 0.95em;
            }

            .highlight {
                font-size: 0.9em;
                padding: 10px;
            }

            #weather-forecast {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)) !important;
                gap: 5px !important;
            }

            #weather-forecast > div {
                padding: 5px !important;
            }

            #weather-forecast > div > div:first-child {
                font-size: 0.8em !important;
            }

            #weather-forecast > div > div:nth-child(2) {
                font-size: 1.5em !important;
            }

            #weather-forecast > div > div:nth-child(3) {
                font-size: 0.9em !important;
            }

            #weather-forecast > div > div:nth-child(4) {
                font-size: 0.75em !important;
            }

            .info-box > div:last-of-type {
                grid-template-columns: 1fr !important;
            }

            .ourcs-flags {
                padding: 15px;
            }

            .ourcs-flags h2 {
                font-size: 1.3em;
            }

            .flags-grid {
                grid-template-columns: 1fr !important;
            }

            .flag-item-status {
                font-size: 2.5em !important;
            }

            .flag-item-text {
                font-size: 1.1em !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö£ Keble College Boat Club River Tracker</h1>
            <p class="subtitle">Godstow Stretch Conditions</p>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading river data...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="stale-warning" class="stale-warning" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="ourcs-flags">
                <h2>OURCS Flag Status</h2>
                <div class="flags-grid">
                    <div class="flag-item">
                        <div class="flag-item-label">Godstow</div>
                        <div class="flag-item-status" id="ourcs-godstow-emoji">--</div>
                        <div class="flag-item-text" id="ourcs-godstow-text">--</div>
                        <div class="flag-item-meta" id="ourcs-godstow-meta"></div>
                        <div class="flag-notice" id="ourcs-godstow-notice" style="display: none;"></div>
                    </div>
                    <div class="flag-item">
                        <div class="flag-item-label">Isis</div>
                        <div class="flag-item-status" id="ourcs-isis-emoji">--</div>
                        <div class="flag-item-text" id="ourcs-isis-text">--</div>
                        <div class="flag-item-meta" id="ourcs-isis-meta"></div>
                        <div class="flag-notice" id="ourcs-isis-notice" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center;">
                    <div>
                        <div class="flag-display" id="flag-status">--</div>
                        <div class="flag-text" id="flag-text">--</div>
                        <div class="flag-description" id="flag-description">--</div>
                    </div>
                    <div class="flow-section" style="margin: 0;">
                        <div class="flow-label">Current Flow</div>
                        <div class="flow-value" id="flow">--</div>
                        <div class="flow-trend" id="flow-trend"></div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <div class="rainfall-section" style="margin-top: 0;">
                        <div class="rainfall-label">24h Rainfall</div>
                        <div class="rainfall-value"><span id="rainfall-24h">--</span> mm</div>
                    </div>
                    <div class="rainfall-section" style="margin-top: 0;">
                        <div class="rainfall-label">7d Rainfall</div>
                        <div class="rainfall-value"><span id="rainfall-7d">--</span> mm</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <h3>üå§Ô∏è 24-Hour Weather Forecast</h3>
                <div id="weather-forecast" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px;">
                    <!-- Weather forecast will be inserted here -->
                </div>
            </div>

            <div class="info-box">
                <h3>üìÖ Upcoming Events</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f9f9f9; border-radius: 4px;">
                        <div style="font-size: 2em; font-weight: bold; color: #667eea;" id="countdown-1-days">--</div>
                        <div style="color: #666; margin-top: 5px;" id="countdown-1-label">Event 1</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f9f9f9; border-radius: 4px;">
                        <div style="font-size: 2em; font-weight: bold; color: #667eea;" id="countdown-2-days">--</div>
                        <div style="color: #666; margin-top: 5px;" id="countdown-2-label">Event 2</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <h3>üìä About This Data</h3>
                <p>This page displays real-time river conditions for the Godstow stretch, using data from Environment Agency monitoring stations at Osney Lock and Godstow Lock on the River Thames.</p>

                <div class="highlight">
                    <strong>Flag Status:</strong><br>
                    üü© Green Flag (Flow under 0.45): No restrictions<br>
                    üüß Amber Flag (Flow 0.45-0.75): X/S-Status coxes only<br>
                    üü• Red Flag (Flow above 0.75): No crews
                </div>

                <div class="highlight">
                    <strong>Flow:</strong> The adjusted river differential between Godstow and Osney locks, accounting for the 1.63m height difference between measurement points. This represents the actual flow gradient through the stretch.
                </div>

                <p><strong>Data Source:</strong> Environment Agency Real-time Flood Monitoring API and OpenMeteo API</p>
                <p><strong>Update Frequency:</strong> 5 times daily at 6am, 9am, 12pm, 3pm, and 6pm UTC</p>
                <p id="data-timestamp" style="margin-top: 15px; font-style: italic; color: #888;"></p>
            </div>

            <div class="last-updated" id="last-updated"></div>
        </div>
    </div>

    <script>
        // Weather code mapping (WMO codes)
        function getWeatherEmoji(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return 'üå®Ô∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return 'üå®Ô∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return '‚òÅÔ∏è';
        }

        function displayWeatherForecast(forecast) {
            const container = document.getElementById('weather-forecast');
            container.innerHTML = '';

            if (!forecast || forecast.length === 0) {
                container.innerHTML = '<p style="color: #999;">Weather forecast unavailable</p>';
                return;
            }

            forecast.forEach((hour, index) => {
                if (index % 3 !== 0) return; // Show every 3 hours

                const time = new Date(hour.time);
                const hourDiv = document.createElement('div');
                hourDiv.style.textAlign = 'center';
                hourDiv.style.padding = '10px';
                hourDiv.style.background = '#fafafa';
                hourDiv.style.borderRadius = '4px';

                hourDiv.innerHTML = `
                    <div style="font-size: 0.9em; color: #666;">${time.getHours()}:00</div>
                    <div style="font-size: 2em; margin: 5px 0;">${getWeatherEmoji(hour.weather_code)}</div>
                    <div style="font-weight: bold; color: #333;">${hour.temperature ? Math.round(hour.temperature) + '¬∞C' : '--'}</div>
                    <div style="font-size: 0.85em; color: #2196F3;">${hour.precipitation_probability ? hour.precipitation_probability + '%' : '--'}</div>
                `;

                container.appendChild(hourDiv);
            });
        }

        function updateCountdowns() {
            const torpids = new Date('2026-03-04T00:00:00');
            const summerEights = new Date('2026-05-27T00:00:00');

            const now = new Date();
            now.setHours(0, 0, 0, 0); // Reset to start of day for accurate day count

            const daysTorpids = Math.ceil((torpids - now) / (1000 * 60 * 60 * 24));
            const daysSummerEights = Math.ceil((summerEights - now) / (1000 * 60 * 60 * 24));

            document.getElementById('countdown-1-days').textContent = daysTorpids > 0 ? daysTorpids : 0;
            document.getElementById('countdown-1-label').textContent = 'Days until Torpids';

            document.getElementById('countdown-2-days').textContent = daysSummerEights > 0 ? daysSummerEights : 0;
            document.getElementById('countdown-2-label').textContent = 'Days until Summer Eights';
        }

        async function loadData() {
            try {
                const response = await fetch('data/current.json?t=' + Date.now());

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Save to localStorage on successful fetch
                localStorage.setItem('riverData', JSON.stringify(data));
                localStorage.setItem('riverDataTimestamp', Date.now().toString());

                // Display the data
                displayData(data);

                // Hide loading, show content, hide warnings
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('stale-warning').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);

                // Try to load from localStorage
                const cachedData = localStorage.getItem('riverData');
                const cachedTimestamp = localStorage.getItem('riverDataTimestamp');

                if (cachedData && cachedTimestamp) {
                    console.log('Using cached data');
                    const data = JSON.parse(cachedData);
                    const cacheAge = Date.now() - parseInt(cachedTimestamp);
                    const hoursOld = Math.floor(cacheAge / (1000 * 60 * 60));
                    const minutesOld = Math.floor((cacheAge % (1000 * 60 * 60)) / (1000 * 60));

                    // Display the cached data
                    displayData(data);

                    // Show stale warning
                    const warningEl = document.getElementById('stale-warning');
                    let ageText = hoursOld > 0 ? `${hoursOld}h ${minutesOld}m` : `${minutesOld}m`;
                    warningEl.innerHTML = `‚ö†Ô∏è Showing cached data (${ageText} old) - unable to fetch latest update`;
                    warningEl.style.display = 'block';

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                } else {
                    // No cached data available
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').innerHTML = `
                        <strong>‚ö†Ô∏è Unable to load river data</strong><br>
                        ${error.message}<br>
                        <small>No cached data available. The data file may not exist yet.</small>
                    `;
                }
            }
        }

        function getFlagEmoji(statusText) {
                // Map OURCS flag status to emoji
                const lower = statusText.toLowerCase();
                if (lower.includes('green')) return 'üü©';
                if (lower.includes('amber') || lower.includes('orange')) return 'üüß';
                if (lower.includes('red')) return 'üü•';
                if (lower.includes('blue')) return 'üü¶';  // All blues use blue square
                if (lower.includes('grey') || lower.includes('gray')) return '‚¨ú';
                return '--';
        }

        function displayOURCSFlags(data) {
                // Display OURCS Godstow flag
                if (data.ourcs_godstow_flag) {
                    const godstow = data.ourcs_godstow_flag;
                    const godstowEmoji = getFlagEmoji(godstow.status_text);
                    document.getElementById('ourcs-godstow-emoji').textContent = godstowEmoji;
                    document.getElementById('ourcs-godstow-text').textContent = godstow.status_text;

                    if (godstow.set_date) {
                        const setDate = new Date(godstow.set_date);
                        document.getElementById('ourcs-godstow-meta').textContent =
                            `Updated ${setDate.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'})}`;
                    }

                    if (godstow.notices && godstow.notices.length > 0) {
                        const noticeEl = document.getElementById('ourcs-godstow-notice');
                        noticeEl.textContent = godstow.notices.join(' ');
                        noticeEl.style.display = 'block';
                    }
                }

                // Display OURCS Isis flag
                if (data.ourcs_isis_flag) {
                    const isis = data.ourcs_isis_flag;
                    const isisEmoji = getFlagEmoji(isis.status_text);
                    document.getElementById('ourcs-isis-emoji').textContent = isisEmoji;
                    document.getElementById('ourcs-isis-text').textContent = isis.status_text;

                    if (isis.set_date) {
                        const setDate = new Date(isis.set_date);
                        document.getElementById('ourcs-isis-meta').textContent =
                            `Updated ${setDate.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'})}`;
                    }

                    if (isis.notices && isis.notices.length > 0) {
                        const noticeEl = document.getElementById('ourcs-isis-notice');
                        noticeEl.textContent = isis.notices.join(' ');
                        noticeEl.style.display = 'block';
                    }
                }
        }

        function displayData(data) {
                // Display OURCS flags
                displayOURCSFlags(data);

                // Calculate flow (adjusted differential)
                let flow = null;
                if (data.differential !== null) {
                    flow = data.differential - 1.63;
                    document.getElementById('flow').textContent = flow.toFixed(3);

                    // Determine flag status
                    let flagEmoji, flagText, flagDescription, flagColor;
                    if (flow > 0.75) {
                        flagEmoji = 'üü•';
                        flagText = 'Red Flag';
                        flagDescription = 'No crews';
                        flagColor = '#dc3545';
                    } else if (flow < 0.45) {
                        flagEmoji = 'üü©';
                        flagText = 'Green Flag';
                        flagDescription = 'No restrictions';
                        flagColor = '#28a745';
                    } else {
                        flagEmoji = 'üüß';
                        flagText = 'Amber Flag';
                        flagDescription = 'X/S-Status coxes only';
                        flagColor = '#fd7e14';
                    }

                    document.getElementById('flag-status').textContent = flagEmoji;
                    document.getElementById('flag-text').textContent = flagText;
                    document.getElementById('flag-text').style.color = flagColor;
                    document.getElementById('flag-description').textContent = flagDescription;
                } else {
                    document.getElementById('flow').textContent = 'N/A';
                    document.getElementById('flag-status').textContent = '--';
                    document.getElementById('flag-text').textContent = '--';
                    document.getElementById('flag-description').textContent = '--';
                }

                // Display flow trend - ensure it shows even if null initially
                const trendElement = document.getElementById('flow-trend');
                if (data.flow_trend) {
                    let trendIcon, trendText, trendColor;
                    if (data.flow_trend === 'increasing') {
                        trendIcon = '‚Üë';
                        trendText = 'Increasing';
                        trendColor = '#dc3545';
                    } else if (data.flow_trend === 'decreasing') {
                        trendIcon = '‚Üì';
                        trendText = 'Decreasing';
                        trendColor = '#28a745';
                    } else if (data.flow_trend === 'level') {
                        trendIcon = '‚Üí';
                        trendText = 'Level';
                        trendColor = '#666';
                    }
                    trendElement.innerHTML = `<span class="trend-icon" style="color: ${trendColor};">${trendIcon}</span><span style="color: ${trendColor};">${trendText}</span>`;
                } else {
                    // Show a message if trend not yet available
                    trendElement.innerHTML = '<span style="color: #999; font-size: 0.9em;">Trend available after next update</span>';
                }

                document.getElementById('rainfall-24h').textContent =
                    data.rainfall_24h ? data.rainfall_24h.toFixed(1) : '0.0';
                document.getElementById('rainfall-7d').textContent =
                    data.rainfall_7d ? data.rainfall_7d.toFixed(1) : '0.0';

                // Display weather forecast
                displayWeatherForecast(data.weather_forecast || []);

                // Display countdowns
                updateCountdowns();

                // Update last updated time
                const lastUpdated = new Date(data.last_updated);
                document.getElementById('last-updated').textContent =
                    `Last updated: ${lastUpdated.toLocaleString('en-GB', {
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    })}`;

                // Update data timestamp (when measurements were taken)
                if (data.godstow_lock && data.godstow_lock.timestamp) {
                    const measurementTime = new Date(data.godstow_lock.timestamp);
                    document.getElementById('data-timestamp').textContent =
                        `Measurements from: ${measurementTime.toLocaleString('en-GB', {
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        })}`;
                } else if (data.osney_lock && data.osney_lock.timestamp) {
                    const measurementTime = new Date(data.osney_lock.timestamp);
                    document.getElementById('data-timestamp').textContent =
                        `Measurements from: ${measurementTime.toLocaleString('en-GB', {
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        })} (Godstow data unavailable)`;
                }
        }

        // Load data when page loads
        loadData();
        
        // Refresh data every 5 minutes (in case it updates)
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>